{% extends "base.html" %}

{% block title %}–ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ IP{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ–ª—ã–º —Å–ø–∏—Å–∫–æ–º IP-–∞–¥—Ä–µ—Å–æ–≤</h2>
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addIpModal">
                        <span>‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å IP
                    </button>
                    <button class="btn btn-secondary" onclick="toggleWhitelist()">
                        <span>‚ö°</span> 
                        <span id="toggleText">{{ '–í—ã–∫–ª—é—á–∏—Ç—å' if config.enabled else '–í–∫–ª—é—á–∏—Ç—å' }}</span>
                    </button>
                    <button class="btn btn-info ms-2" onclick="refreshWhitelist()">
                        <span>üîÑ</span> –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç—É—Å –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title">–°—Ç–∞—Ç—É—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <span class="text-{{ 'success' if config.enabled else 'danger' }} me-2">üõ°Ô∏è</span>
                                <span class="fw-bold">–ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫: 
                                    <span class="text-{{ 'success' if config.enabled else 'danger' }}">
                                        {{ '–ê–∫—Ç–∏–≤–µ–Ω' if config.enabled else '–û—Ç–∫–ª—é—á–µ–Ω' }}
                                    </span>
                                </span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <span class="text-info me-2">üìã</span>
                                <span>–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö IP: <strong>{{ config.whitelist_count }}</strong></span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <span class="text-primary me-2">üë§</span>
                                <span>–û–±–Ω–æ–≤–ª–µ–Ω–æ: <strong>{{ config.updated_by }}</strong></span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <span class="text-warning me-2">‚è∞</span>
                                <span>–í—Ä–µ–º—è: <strong>{{ config.last_updated[:16] if config.last_updated else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –¢–µ–∫—É—â–∏–π IP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            <div class="alert alert-info">
                <span class="me-2">‚ÑπÔ∏è</span>
                –í–∞—à —Ç–µ–∫—É—â–∏–π IP-–∞–¥—Ä–µ—Å: <strong>{{ client_ip }}</strong>
                {% if client_ip in whitelist %}
                    <span class="badge bg-success ms-2">–†–∞–∑—Ä–µ—à–µ–Ω</span>
                {% else %}
                    <span class="badge bg-danger ms-2">–ù–µ –≤ —Å–ø–∏—Å–∫–µ</span>
                {% endif %}
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∏–ø–∞—Ö IP-–∞–¥—Ä–µ—Å–æ–≤ -->
            <div class="alert alert-warning">
                <strong>üìã –¢–∏–ø—ã IP-–∞–¥—Ä–µ—Å–æ–≤:</strong>
                <ul class="mb-0 mt-2">
                    <li><span class="badge bg-warning me-2">üîí –°–∏—Å—Ç–µ–º–Ω—ã–µ</span> - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ (localhost, —Å–µ—Ä–≤–µ—Ä), –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç —É–¥–∞–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞–º–∏</li>
                    <li><span class="badge bg-success me-2">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ</span> - –æ–±—ã—á–Ω—ã–µ IP-–∞–¥—Ä–µ—Å–∞, –º–æ–≥—É—Ç –±—ã—Ç—å —É–¥–∞–ª–µ–Ω—ã –∞–¥–º–∏–Ω–∞–º–∏</li>
                    <li><span class="badge bg-secondary me-2">–ü–æ–¥—Å–µ—Ç–∏</span> - –¥–∏–∞–ø–∞–∑–æ–Ω—ã IP-–∞–¥—Ä–µ—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 192.168.1.0/24)</li>
                </ul>
            </div>

            <!-- –¢–∞–±–ª–∏—Ü–∞ IP-–∞–¥—Ä–µ—Å–æ–≤ -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ IP-–∞–¥—Ä–µ—Å–∞</h5>
                </div>
                <div class="card-body">
                    {% if whitelist %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>IP-–∞–¥—Ä–µ—Å</th>
                                        <th>–¢–∏–ø</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for ip in whitelist %}
                                    <tr>
                                        <td>
                                            <code>{{ ip }}</code>
                                            {% if ip == client_ip %}
                                                <span class="badge bg-primary ms-2">–í–∞—à IP</span>
                                            {% endif %}
                                            
                                            {% set is_system_ip = false %}
                                            {% for group_name, group_data in groups.items() %}
                                                {% if ip in group_data.addresses and group_data.protected %}
                                                    {% set is_system_ip = true %}
                                                {% endif %}
                                            {% endfor %}
                                            
                                            {% if is_system_ip %}
                                                <span class="badge bg-warning ms-2">üîí –ó–∞—â–∏—â–µ–Ω</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% set ip_group = 'user' %}
                                            {% for group_name, group_data in groups.items() %}
                                                {% if ip in group_data.addresses %}
                                                    {% set ip_group = group_name %}
                                                {% endif %}
                                            {% endfor %}
                                            
                                            {% if ip_group == 'system' %}
                                                <span class="badge bg-warning">–°–∏—Å—Ç–µ–º–Ω—ã–π</span>
                                            {% elif '/' in ip %}
                                                <span class="badge bg-secondary">–ü–æ–¥—Å–µ—Ç—å</span>
                                            {% else %}
                                                <span class="badge bg-success">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% set is_system_ip = false %}
                                            {% for group_name, group_data in groups.items() %}
                                                {% if ip in group_data.addresses and group_data.protected %}
                                                    {% set is_system_ip = true %}
                                                {% endif %}
                                            {% endfor %}
                                            
                                            {% if is_system_ip %}
                                                {% if user_role == 'superadmin' %}
                                                    <button class="btn btn-sm btn-outline-danger" onclick="removeIp('{{ ip }}')">
                                                        <span>üóëÔ∏è</span> –£–¥–∞–ª–∏—Ç—å
                                                    </button>
                                                    <small class="text-warning d-block">‚ö†Ô∏è –°–∏—Å—Ç–µ–º–Ω—ã–π IP</small>
                                                {% else %}
                                                    <span class="text-muted">üîí –ó–∞—â–∏—â–µ–Ω</span>
                                                    <small class="text-muted d-block">–¢–æ–ª—å–∫–æ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω</small>
                                                {% endif %}
                                            {% else %}
                                                <button class="btn btn-sm btn-outline-danger" onclick="removeIp('{{ ip }}')">
                                                    <span>üóëÔ∏è</span> –£–¥–∞–ª–∏—Ç—å
                                                </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <span class="mb-3" style="font-size: 3rem;">üìã</span>
                            <p>–ù–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö IP-–∞–¥—Ä–µ—Å–æ–≤</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è IP -->
<div class="modal fade" id="addIpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å IP-–∞–¥—Ä–µ—Å</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addIpForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="ipAddress" class="form-label">IP-–∞–¥—Ä–µ—Å</label>
                        <input type="text" class="form-control" id="ipAddress" name="ip_address" 
                               placeholder="192.168.1.100 –∏–ª–∏ 192.168.1.0/24" required>
                        <div class="form-text">
                            –í–≤–µ–¥–∏—Ç–µ IP-–∞–¥—Ä–µ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, 192.168.1.100) –∏–ª–∏ –ø–æ–¥—Å–µ—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, 192.168.1.0/24)
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// WebSocket connection for real-time updates
let socket;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize WebSocket connection
    socket = io();
    
    // Handle WebSocket connection
    socket.on('connect', function() {
        console.log('Connected to WebSocket server');
    });
    
    socket.on('disconnect', function() {
        console.log('Disconnected from WebSocket server');
    });
    
    // Handle real-time whitelist updates
    socket.on('whitelist_update', function(data) {
        console.log('Whitelist update received:', data);
        
        // Show notification about the change
        showNotification(data.message, 'success');
        
        // Update the page content without full reload
        updateWhitelistContent(data);
    });
    
    // Handle file change notifications
    socket.on('whitelist_file_change', function(data) {
        console.log('Whitelist file change detected:', data);
        
        // Show notification about external file change
        showNotification('–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –≤–Ω–µ—à–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏', 'info');
        
        // Auto-reload page to reflect file changes
        setTimeout(() => {
            location.reload();
        }, 1500);
    });
});

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <span>${message}</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

function updateWhitelistContent(data) {
    try {
        // Update status information
        if (data.config) {
            const statusBadge = document.querySelector('.card-header .badge');
            if (statusBadge) {
                statusBadge.textContent = data.config.enabled ? '–í–∫–ª—é—á–µ–Ω' : '–û—Ç–∫–ª—é—á–µ–Ω';
                statusBadge.className = `badge ${data.config.enabled ? 'bg-success' : 'bg-danger'}`;
            }
            
            // Update toggle button text
            const toggleText = document.getElementById('toggleText');
            if (toggleText) {
                toggleText.textContent = data.config.enabled ? '–í—ã–∫–ª—é—á–∏—Ç—å' : '–í–∫–ª—é—á–∏—Ç—å';
            }
            
            // Update last updated time
            const lastUpdated = document.querySelector('.text-warning strong');
            if (lastUpdated && data.config.last_updated) {
                lastUpdated.textContent = data.config.last_updated.substring(0, 16);
            }
        }
        
        // Reload page to show updated whitelist data
        // This ensures consistent display with server state
        setTimeout(() => {
            location.reload();
        }, 1000);
        
    } catch (error) {
        console.error('Error updating whitelist content:', error);
    }
}

document.getElementById('addIpForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    fetch('/ip_whitelist/add', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addIpModal'));
            if (modal) {
                modal.hide();
            }
            // Clear form
            document.getElementById('addIpForm').reset();
            // Success notification will be handled by WebSocket
        } else {
            showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error, 'error');
    });
});

function removeIp(ip) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å IP-–∞–¥—Ä–µ—Å: ' + ip + '?')) {
        const formData = new FormData();
        formData.append('ip_address', ip);
        
        fetch('/ip_whitelist/remove', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
            // Success notification will be handled by WebSocket
        })
        .catch(error => {
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error, 'error');
        });
    }
}

function toggleWhitelist() {
    const formData = new FormData();
    formData.append('enabled', document.getElementById('toggleText').textContent === '–í—ã–∫–ª—é—á–∏—Ç—å' ? 'false' : 'true');
    
    fetch('/ip_whitelist/toggle', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
        }
        // Success notification will be handled by WebSocket
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error, 'error');
    });
}

function refreshWhitelist() {
    fetch('/ip_whitelist/refresh', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
        }
        // Success notification will be handled by WebSocket
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error, 'error');
    });
}
</script>
{% endblock %}